<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Streaming</title>
</head>
<body>
    <video id="videoPlayer" controls width="640" height="360"></video>
    <script>
        const video = document.getElementById('videoPlayer');
        const videoUrl = 'http://localhost:5000/upload/1722610250593-video2.mp4';

        if ('MediaSource' in window && MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E, mp4a.40.2"')) {
            const mediaSource = new MediaSource();
            video.src = URL.createObjectURL(mediaSource);

            mediaSource.addEventListener('sourceopen', () => {
                const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E, mp4a.40.2"');

                let start = 0;
                const chunkSize = 1000000; // Adjust this size as needed

                const fetchVideoChunk = async () => {
                    if (mediaSource.readyState === 'open' && !sourceBuffer.updating) {
                        const rangeHeader = `bytes=${start}-${start + chunkSize - 1}`;
                        console.log('Requesting range:', rangeHeader); // Debug: log the range being requested

                        const response = await fetch(videoUrl, {
                            method: 'GET',
                            headers: { 'Range': rangeHeader }
                        });

                        console.log('Response status:', response.status); // Debug: log the response status

                        if (response.ok) {
                            const data = await response.arrayBuffer();
                            console.log('Appending data to SourceBuffer'); // Debug: log when appending data
                            sourceBuffer.appendBuffer(data);
                            start += chunkSize;

                            if (start >= mediaSource.duration) {
                                mediaSource.endOfStream();
                                console.log('End of stream'); // Debug: log when end of stream is reached
                            }
                        } else {
                            console.error('Error fetching video chunk:', response.statusText); // Debug: log error status
                        }
                    }
                };

                sourceBuffer.addEventListener('updateend', fetchVideoChunk);
                fetchVideoChunk();
            });

            mediaSource.addEventListener('error', (e) => {
                console.error('MediaSource error:', e); // Debug: log MediaSource error
            });
        } else {
            console.error('Unsupported MIME type or codec: video/mp4; codecs="avc1.42E01E, mp4a.40.2"');
        }
    </script>
</body>
</html>
